name: CI (main)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  WORKDIR: N2O-ConteinerGuard
  PY_VER: "3.12"
  POETRY_VER: "2.2.1"
  IMAGE_LOCAL: app:ci-${{ github.sha }}
  IMAGE_REMOTE: ghcr.io/${{ github.repository }}/app

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VER }}
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ env.PY_VER }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PY_VER }}-
            venv-${{ runner.os }}-

      - name: Install deps
        working-directory: ${{ env.WORKDIR }}
        run: |
          poetry --version
          poetry install --no-interaction --no-root --sync

      - name: Ruff
        working-directory: ${{ env.WORKDIR }}
        run: |
          export PYTHONPATH="$PYTHONPATH:${{ env.WORKDIR }}"
          poetry run ruff check app tests

  tests:
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: unit
            pattern: tests/unit/**/*.py
            pytest_args: -q
          - name: integration
            pattern: tests/integration/**/*.py
            pytest_args: -q
          - name: e2e
            pattern: tests/e2e/**/*.py
            pytest_args: -q
          # временно — чтобы покрыть одиночные тесты в корне tests/
          - name: general
            pattern: tests/*.py
            pytest_args: -q
    name: tests (${{ matrix.name }})
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VER }}
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ env.PY_VER }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PY_VER }}-
            venv-${{ runner.os }}-

      - name: Install deps
        working-directory: ${{ env.WORKDIR }}
        run: |
          poetry --version
          poetry install --no-interaction --no-root --sync

      - name: Detect test files
        id: detect
        shell: bash
        working-directory: ${{ env.WORKDIR }}
        run: |
          shopt -s nullglob globstar
          files=( ${matrix.pattern} )
          if [[ ${#files[@]} -gt 0 ]]; then
            echo "found=true" >> $GITHUB_OUTPUT
            printf 'Detected %d files for pattern "%s"\n' "${#files[@]}" "${{ matrix.pattern }}"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            printf 'No files for pattern "%s" — skipping.\n' "${{ matrix.pattern }}"
          fi

      - name: Run pytest (${{ matrix.name }})
        if: steps.detect.outputs.found == 'true'
        shell: bash
        working-directory: ${{ env.WORKDIR }}
        run: |
          export PYTHONPATH="$PYTHONPATH:${{ env.WORKDIR }}"
          poetry run pytest ${{ matrix.pytest_args }} ${{ matrix.pattern }}

      - name: Skip (no tests)
        if: steps.detect.outputs.found != 'true'
        shell: bash
        run: |
          echo "Skipping ${{ matrix.name }} tests: no files matched '${{ matrix.pattern }}'."

  build-and-publish:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4

      # Сборка контейнера из корня репозитория (ожидается Dockerfile в корне)
      - name: Build container
        run: docker build -t $IMAGE_LOCAL .

      # Простой smoke-тест контейнера
      - name: Smoke test container
        run: |
          set -euo pipefail
          cid=$(docker run -d -p 8001:8001 $IMAGE_LOCAL)
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8001/api/health >/dev/null; then
              echo "Healthcheck passed"
              ok=1
              break
            fi
            sleep 1
          done
          test "${ok:-0}" = "1"
          docker rm -f "$cid" >/dev/null 2>&1 || true

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag & Push to GHCR
        run: |
          docker tag $IMAGE_LOCAL $IMAGE_REMOTE:sha-${{ github.sha }}
          docker tag $IMAGE_LOCAL $IMAGE_REMOTE:latest
          docker push $IMAGE_REMOTE:sha-${{ github.sha }}
          docker push $IMAGE_REMOTE:latest
