name: CI (main)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  WORKDIR: N2O-ConteinerGuard
  IMAGE_LOCAL: app:ci-${{ github.sha }}
  IMAGE_REMOTE: ghcr.io/${{ github.repository }}/app
  PY_VER: "3.12"

jobs:
  install:
    name: Install project
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    env:
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry --version
          poetry config virtualenvs.in-project true

      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}
          restore-keys: |
            venv-${{ runner.os }}-

      - name: Install deps (poetry)
        run: poetry install --no-interaction

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: install
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    env:
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}
      - uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}

      - name: Run ruff & black check
        run: |
          poetry run ruff check app tests
          poetry run black --check .

  test-unit:
    name: Tests (unit)
    runs-on: ubuntu-latest
    needs: install
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    env:
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}
      - uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}

      - name: Run unit tests
        run: |
          if [ -d tests/unit ]; then
            poetry run pytest -q tests/unit
          else
            poetry run pytest -q
          fi

  test-integration:
    name: Tests (integration)
    runs-on: ubuntu-latest
    needs: install
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    env:
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}
      - uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}

      - name: Run integration tests (if present)
        run: |
          if [ -d tests/integration ]; then
            poetry run pytest -q tests/integration
          else
            echo "No tests/integration, skipping."
          fi

  test-e2e:
    name: Tests (e2e)
    runs-on: ubuntu-latest
    needs: install
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    env:
      PYTHONPATH: .
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}
      - uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}

      - name: Run e2e tests (if present)
        run: |
          if [ -d tests/e2e ]; then
            poetry run pytest -q tests/e2e
          else
            echo "No tests/e2e, skipping."
          fi

  build-and-publish:
    name: Build & Publish
    runs-on: ubuntu-latest
    needs:
      - lint
      - test-unit
      - test-integration
      - test-e2e
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4

      - name: Build container
        run: docker build -t $IMAGE_LOCAL .

      - name: Smoke test container
        run: |
          cid=$(docker run -d -p 8001:8001 $IMAGE_LOCAL)
          for i in {1..20}; do
            curl -fsS http://127.0.0.1:8001/api/health && ok=1 && break || sleep 1
          done
          test "$ok" = "1"
          docker rm -f "$cid" >/dev/null 2>&1 || true

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag & Push to GHCR
        run: |
          docker tag $IMAGE_LOCAL $IMAGE_REMOTE:sha-${{ github.sha }}
          docker tag $IMAGE_LOCAL $IMAGE_REMOTE:latest
          docker push $IMAGE_REMOTE:sha-${{ github.sha }}
          docker push $IMAGE_REMOTE:latest
