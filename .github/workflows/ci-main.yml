name: CI (main)

on:
  push:
    branches: [release]
  workflow_dispatch:

env:
  WORKDIR: N2O-ConteinerGuard
  PY_VER: "3.12"
  POETRY_VER: "2.2.1"
  IMAGE_LOCAL: app:ci-${{ github.sha }}
  IMAGE_REMOTE: ghcr.io/${{ github.repository }}/app

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VER }}
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ env.PY_VER }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PY_VER }}-
            venv-${{ runner.os }}-

      - name: Install deps
        working-directory: ${{ env.WORKDIR }}
        run: |
          poetry --version
          poetry install --no-interaction --no-root --sync

      - name: Ruff
        working-directory: ${{ env.WORKDIR }}
        run: poetry run ruff check backend/app backend/tests

  tests:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}

      - uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VER }}
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: ${{ env.WORKDIR }}/.venv
          key: venv-${{ runner.os }}-${{ env.PY_VER }}-${{ hashFiles(format('{0}/poetry.lock', env.WORKDIR)) }}
          restore-keys: |
            venv-${{ runner.os }}-${{ env.PY_VER }}-
            venv-${{ runner.os }}-

      - name: Install deps
        working-directory: ${{ env.WORKDIR }}
        run: |
          poetry --version
          poetry install --no-interaction --no-root --sync

      - name: Run pytest
        working-directory: ${{ env.WORKDIR }}
        run: poetry run pytest backend/tests -q

  build-and-publish:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4

      # ���+�?�?��� ��?�?�'����?��?�� ��� ��?�?�?�? �?����?����'�?�?��? (�?���?����'�?�? Dockerfile �? ��?�?�?��)
      - name: Build container
        run: docker build -t $IMAGE_LOCAL .

      # �?�?�?�?�'�?�� smoke-�'��?�' ��?�?�'����?��?��
      - name: Smoke test container
        run: |
          set -euo pipefail
          cid=$(docker run -d -p 8001:8001 $IMAGE_LOCAL)
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8001/health >/dev/null; then
              echo "Healthcheck passed"
              ok=1
              break
            fi
            sleep 1
          done
          test "${ok:-0}" = "1"
          docker rm -f "$cid" >/dev/null 2>&1 || true

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Tag & Push to GHCR
        run: |
          docker tag $IMAGE_LOCAL $IMAGE_REMOTE:sha-${{ github.sha }}
          docker tag $IMAGE_LOCAL $IMAGE_REMOTE:latest
          docker push $IMAGE_REMOTE:sha-${{ github.sha }}
          docker push $IMAGE_REMOTE:latest
